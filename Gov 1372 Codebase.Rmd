---
output:
  pdf_document: default
  html_document: default
---
```{r}
library(tidyverse)
library(ggplot2)
library(stringr)
library(dplyr)
library(readr)
library(tigris)
library(sf)
```

```{r}
library(dplyr)

props <- read.csv("Ohio Ballot Issues 2023.csv")

props <- props[-c(1:3), ]

colnames(props) <- c(
  "County Name", "Precinct Name", "Precinct Code", "Region Name",
  "Media Market", "Registered Voters", "Ballots Counted",
  "Official Voter Turnout", "abortion_yes", "abortion_no",
  "weed_yes", "weed_no"
)

props <- props |>
  mutate(
    across(c("abortion_yes", "abortion_no", "weed_yes", "weed_no",
             "Official Voter Turnout", "Ballots Counted"),
           ~ as.numeric(gsub("[,%]", "", .x))),

    abortion_diff = abortion_yes - abortion_no,
    weed_diff     = weed_yes - weed_no,
    abortion_weed_diff = abortion_diff - weed_diff,
    
    weed_total = weed_yes + weed_no,
    abortion_total = abortion_yes + abortion_no,
    dif_turnout = abortion_total - weed_total,

    abortion_margin = (abortion_diff / abortion_total) * 100,
    weed_margin     = (weed_diff     / weed_total) * 100,
    diff_margin     = (abortion_weed_diff / `Ballots Counted`) * 100,

    across(c(abortion_margin, weed_margin, diff_margin),
           ~ round(.x, 2)),

    ballots_norm = ((`Ballots Counted` - 1) / (1540 - 1)) + 0.01
  )
```

```{r}
margin_scatterplot <- ggplot(props, aes(x = weed_margin, y = abortion_margin)) +
  geom_jitter(
    aes(size = ballots_norm, alpha = `Official Voter Turnout`),
    color = "steelblue1"
  ) +
  scale_size_continuous(range = c(1, 4)) +
  geom_smooth(method = "loess", color = "grey64", se = FALSE) +
  labs(
    title = "Precinct-Level Margins: Abortion vs. Marijuana",
    x = "Marijuana Margin (%)",
    y = "Abortion Margin (%)",
    size = "Normalized\nBallots Counted"
  ) +
  theme_minimal()

margin_scatterplot
```

```{r}
unique(props$`Media Market`)
```

```{r}
margin_scatterplot_2 <- props |> 
  slice_sample(n = 500) |> 
  ggplot(aes(x = weed_margin, y = abortion_margin)) +
  geom_jitter(aes(size = ballots_norm), alpha = 0.6, color = "steelblue1") +
  scale_size_continuous(range = c(1, 4)) +
  geom_smooth(method = "loess", color = "steelblue4", se = FALSE) +
  theme_minimal()

margin_scatterplot_2
```



```{r}
library(sf)
library(dplyr)
library(ggplot2)
library(stringr)

clean_precinct_name <- function(x) {
  x <- toupper(trimws(x))

  x <- gsub("^\\d{3}\\s+", "", x)
  x <- gsub("^PRECINCT\\s+", "", x)
  x <- gsub("^PREC\\s+",     "", x)
  x <- gsub("[[:punct:]/]+", " ", x)
  x <- gsub("\\bTOWNSHIP\\b", "", x)
  x <- gsub("\\bTWP\\b",       "", x)
  x <- gsub("\\bTP\\b",        "", x)
  x <- gsub("\\bPRECINCT\\b",  "", x)
  x <- gsub("\\bPREC\\b",      "", x)
  x <- gsub("\\bWARD\\b",      "", x)
  x <- gsub("\\bCITY\\b",      "", x)
  x <- gsub("\\bVILLAGE\\b",   "", x)
  x <- gsub("\\bDISTRICT\\b",  "", x)
  x <- gsub("\\b0+([0-9])", "\\1", x)
  x <- gsub("\\s+", " ", x)
  x <- trimws(x)

  x
}

expand_richland_city <- function(precinct_name, county_name) {
  richland_map <- c(
    "MAN"   = "MANSFIELD",
    "SHL"   = "SHELBY",
    "LEX"   = "LEXINGTON",
    "ONT"   = "ONTARIO",
    "SPFLD" = "SPRINGFIELD",
    "BLMG"  = "BLOOMINGGROVE",
    "JEFF"  = "JEFFERSON",
    "JACK"  = "JACKSON",
    "MAD"   = "MADISON",
    "MIFF"  = "MIFFLIN",
    "MON"   = "MONROE",
    "PLY"   = "PLYMOUTH",
    "SAND"  = "SANDUSKY",
    "WASH"  = "WASHINGTON",
    "WORTH" = "WORTHINGTON"
  )

  precinct_upper <- toupper(precinct_name)
  county_upper   <- toupper(county_name)

  is_richland <- grepl("RICHLAND", county_upper)

  out <- precinct_upper

  out[is_richland] <- vapply(
    out[is_richland],
    function(z) {
      tokens <- stringr::str_split(z, "\\s+", simplify = TRUE)
      if (ncol(tokens) == 0 || nchar(tokens[1]) == 0) {
        return(z)
      }

      first <- tokens[1]

      if (first %in% names(richland_map)) {
        tokens[1] <- richland_map[[first]]
      }

      paste(tokens, collapse = " ")
    },
    character(1)
  )

  out
}

ohio_sf <- st_read("ohio_shapefile/tl_2020_39_vtd20.shp")

ohio_sf <- ohio_sf |>
  mutate(
    NAME20 = clean_precinct_name(NAME20)
  )

props_clean <- props |>
  mutate(
    Precinct_Expanded = expand_richland_city(`Precinct Name`, `County Name`),
    Precinct_clean    = clean_precinct_name(Precinct_Expanded)
  )

ohio_joined <- ohio_sf |>
  left_join(props_clean, by = c("NAME20" = "Precinct_clean")) |>
  st_as_sf()
```

```{r}
ggplot(ohio_joined) +
  geom_sf(aes(fill = diff_margin), color = NA) +
  scale_fill_gradient2(
    low = "forestgreen",
    mid = "white",
    high = "darkviolet",
    midpoint = 0,
    name = "Abortion â€“ Weed\nMargin (pp)"
  ) +
  labs(
    title = "Ohio Precinct-Level Disparities\nAbortion vs. Marijuana Ballot Margins (2023)",
    caption = "Positive = More support for abortion than weed"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  )
```

```{r}
unmatched <- ohio_joined |> 
  filter(is.na(diff_margin)) |> 
  select(NAME20)

unmatched

unmatched_map <- ohio_joined |>
  filter(is.na(diff_margin)) |>
  st_drop_geometry() |>
  distinct(NAME20) |>
  arrange(NAME20)

unmatched_props <- props_clean |>
  anti_join(ohio_sf |> st_drop_geometry(),
            by = c("Precinct Name" = "NAME20")) |>
  distinct(`Precinct Name`) |>
  arrange(`Precinct Name`)

write.csv(unmatched_map,   "unmatched_map.csv",   row.names = FALSE)
write.csv(unmatched_props, "unmatched_props.csv", row.names = FALSE)
```


```{r}
ggplot(ohio_joined) +
  geom_sf(aes(fill = abortion_margin), color = NA) +
  scale_fill_gradient2(
    low = "darkred",
    high = "darkblue",
    midpoint = 0,
    name = "Abortion Margin (pp)"
  ) +
  labs(
    title = "Ohio Abortion Referendum (2023)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  )
```

```{r}
ggplot(ohio_joined) +
  geom_sf(aes(fill = weed_margin), color = NA) +
  scale_fill_gradient2(
    low = "darkred",
    high = "darkblue",
    midpoint = 0,
    name = "Marijuana Margin (pp)"
  ) +
  labs(
    title = "Ohio Marijuana Referendum (2023)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  )
```

```{r}
ggplot(ohio_joined) +
  geom_sf(aes(fill = `Official Voter Turnout`), color = NA) +
  scale_fill_gradient2(
    low = "white",
    high = "darkgreen",
    midpoint = 0,
    name = "Turnout (%)"
  ) +
  labs(
    title = "Ohio Marijuana Referendum Turnout (2023)"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right"
  )
```

```{r}
raw_unmatched_map <- ohio_sf |> 
  st_drop_geometry() |> 
  distinct(NAME20) |> 
  arrange(NAME20)

raw_unmatched_props <- props |> 
  distinct(`Precinct Name`) |> 
  arrange(`Precinct Name`)

write.csv(raw_unmatched_map, "raw_unmatched_map.csv", row.names = FALSE)
write.csv(raw_unmatched_props, "raw_unmatched_props.csv", row.names = FALSE)
```

